<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Chatbot - BGVSIndia</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,300;1,400;1,500;1,600;1,700;1,800&family=Marcellus:wght@400&display=swap"
    rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">
  <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">

  <!-- Main CSS File -->
  <link href="assets/css/main.css" rel="stylesheet">

  <!-- Page-specific chat styles -->
  <style>
    /* Ensure a tall chat area similar to previous behavior */
    #chatbot .card-body {
      min-height: 60vh;            /* adjust if you want taller */
      display: flex;
      flex-direction: column;
    }
    /* Messages list fills the available space and scrolls */
    #messages {
      flex: 1;
      overflow: auto;
    }
  </style>
</head>

<body class="about-page">
  <!-- Header -->
  <header id="header" class="header d-flex align-items-center position-relative">
    <div class="container-fluid container-xl position-relative d-flex align-items-center justify-content-between">
      <a href="index.html" class="logo d-flex align-items-center">
        <img src="assets/img/logo.png" alt="BGVS India">
      </a>

      <nav id="navmenu" class="navmenu">
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="about.html">About Us</a></li>
          <li><a href="services.html">PGS India</a></li>
          <li><a href="contact.html">Contact</a></li>
          <li><a href="chatbot.html" class="active">Chatbot</a></li>
        </ul>
        <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
      </nav>
    </div>
  </header>

  <main class="main">

    <!-- Page Title (matches other pages) -->
    <div class="page-title dark-background" data-aos="fade"
      style="background-image: url(assets/img/page-title-bg.webp);">
      <div class="container position-relative">
        <h1>Chatbot</h1>
        <nav class="breadcrumbs">
          <ol>
            <li><a href="index.html">Home</a></li>
            <li class="current">Chatbot</li>
          </ol>
        </nav>
      </div>
    </div>

    <!-- Chat Section -->
    <section id="chatbot" class="section">
      <div class="container" data-aos="fade-up">
        <div class="row justify-content-center">
          <div class="col-lg-10">
            <div class="card shadow-sm">
              <div class="card-header d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-2">
                  <i class="bi bi-chat-dots"></i>
                  <strong>BGVS Assistant</strong>
                </div>
                <small id="status" class="text-muted">Connecting…</small>
              </div>
              <div class="card-body">
                <!-- removed inline max-height; handled via CSS above -->
                <ul id="messages" class="list-unstyled mb-3"></ul>

                <form id="form" class="d-flex gap-2" autocomplete="off">
                  <input id="input" type="text" class="form-control" placeholder="Type your message and press Enter" />
                  <button type="submit" class="btn btn-success">
                    <i class="bi bi-send"></i> Send
                  </button>
                </form>
                <div class="form-text mt-2">
                  The assistant may take a few seconds to reply.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>      
    </section>

  </main>

  <!-- Footer (matches site layout) -->
  <footer id="footer" class="footer dark-background">

    <div class="footer-top">
      <div class="container">
        <div class="row gy-4">
          <div class="col-lg-4 col-md-6 footer-about">
            <a href="index.html" class="logo d-flex align-items-center">
              <span class="sitename">BGVS India</span>
            </a>
            <div class="footer-contact pt-3">
              <p>Bhartiya Gramin Vikas Sansthan</p>
              <p>Ward No -3, Near Water Tank</p>
              <p> Bhagat Singh Colony Nagarpura</p>
              <p> Nawalgarh, Jhunjhunu</p>
              <p>Rajasthan – 333042</p>
              <p class="mt-3"><strong>Phone:</strong> <span>+91- 7877523833</span></p>
              <p><strong>Email:</strong> <span>bgvsnawalgarh2010@gmail.com</span></p>
            </div>
          </div>

          <div class="col-lg-2 col-md-3 footer-links">
            <h4>Useful Links</h4>
            <ul>
              <li><a href="/">Home</a></li>
              <li><a href="/about.html">About us</a></li>
              <li><a href="/services.html">PGS India</a></li>
              <li><a href="/tos.html">Terms of service</a></li>
              <li><a href="/pp.html">Privacy policy</a></li>
            </ul>
          </div>

          <div class="col-lg-2 col-md-3 footer-links">
            <h4>Download</h4>
            <ul>
              <li><a href="/assets/downloads/PGS_India_Standards.pdf">PGS India Standards</a></li>
              <li><a href="/assets/downloads/PGS%20India_Guidlines.pdf">PGS India Operational Manual</a></li>
              <li><a href="/assets/downloads/ROLES%20AND%20RESPONSIBILITIES.docx">Roles and Responsibilities</a></li>
            </ul>
          </div>

          <div class="col-lg-4 col-md-6">
            <h4>Newsletter</h4>
            <p>Subscribe for updates.</p>
            <form class="php-email-form">
              <div class="newsletter-form d-flex">
                <input type="email" name="email" class="form-control" placeholder="Enter your e-mail">
                <input type="submit" class="btn btn-secondary ms-2" value="Subscribe">
              </div>
              <div class="loading">Loading</div>
              <div class="error-message"></div>
              <div class="sent-message">Your subscription request has been sent. Thank you!</div>
            </form>
          </div>

        </div>
      </div>
    </div>

    <div class="copyright text-center">
      <div
        class="container d-flex flex-column flex-lg-row justify-content-center justify-content-lg-between align-items-center">
        <div class="d-flex flex-column align-items-center align-items-lg-start">
          <div>
            © Copyright <strong><span>BGVSIndia.com</span></strong>. All Rights Reserved
          </div>
          <div class="credits">
            Designed by <a href="https://www.doions.com/">DOIONS</a>
          </div>
        </div>

        <div class="social-links order-first order-lg-last mb-3 mb-lg-0">
          <a href=""><i class="bi bi-twitter-x"></i></a>
          <a href=""><i class="bi bi-facebook"></i></a>
          <a href=""><i class="bi bi-instagram"></i></a>
          <a href=""><i class="bi bi-linkedin"></i></a>
        </div>

      </div>
    </div>
  </footer>

  <!-- Scroll Top -->
  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i
      class="bi bi-arrow-up-short"></i></a>

  <!-- Preloader -->
  <div id="preloader"></div>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/php-email-form/validate.js"></script>
  <script src="assets/vendor/aos/aos.js"></script>
  <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>
  <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>

  <!-- Main JS File -->
  <script src="assets/js/main.js"></script>

  <!-- Socket.IO client -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>

  <!-- Chat logic (keeps your existing event names) -->
  <script>
    // Auto-pick local or production
    const SOCKET_URL =
      (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
        ? 'http://localhost:3000'
        : 'https://mytym.in';
    const SOCKET_PATH = '/socket.io';

    const messagesEl = document.getElementById('messages');
    const statusEl = document.getElementById('status');
    const formEl = document.getElementById('form');
    const inputEl = document.getElementById('input');

    function addMessage(who, text) {
      const li = document.createElement('li');
      li.className = 'd-flex mb-2';
      const bubble = document.createElement('div');
      bubble.className = who === 'me'
        ? 'ms-auto bg-success text-white rounded-3 px-3 py-2'
        : 'me-auto bg-light rounded-3 px-3 py-2';
      bubble.style.maxWidth = '80%';
      bubble.style.wordBreak = 'break-word';
      bubble.textContent = text;
      li.appendChild(bubble);
      messagesEl.appendChild(li);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // Loader helpers
    let pendingLi = null;
    function showLoader() {
      if (pendingLi) return;
      pendingLi = document.createElement('li');
      pendingLi.className = 'd-flex mb-2';
      const bubble = document.createElement('div');
      bubble.className = 'me-auto bg-light rounded-3 px-3 py-2 d-flex align-items-center gap-2';
      bubble.style.maxWidth = '80%';
      bubble.style.wordBreak = 'break-word';
      bubble.innerHTML = '<span class="spinner-border spinner-border-sm text-secondary" role="status" aria-hidden="true"></span><span> Thinking…</span>';
      pendingLi.appendChild(bubble);
      messagesEl.appendChild(pendingLi);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
    function resolveLoader(text) {
      if (!pendingLi) { if (text) addMessage('bot', text); return; }
      const bubble = pendingLi.querySelector('div');
      bubble.className = 'me-auto bg-light rounded-3 px-3 py-2';
      bubble.innerHTML = '';
      bubble.textContent = text || 'No reply.';
      pendingLi = null;
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    const socket = io(SOCKET_URL, {
      path: SOCKET_PATH,
      transports: ['websocket', 'polling'],
      reconnection: true,
      reconnectionAttempts: Infinity,
      reconnectionDelay: 1000
    });

    socket.on('connect', () => {
      statusEl.textContent = `Connected (#${socket.id})`;
    });

    socket.on('disconnect', (reason) => {
      statusEl.textContent = `Disconnected (${reason})`;
    });

    socket.on('connect_error', (err) => {
      statusEl.textContent = `Error: ${err.message}`;
      console.error('[socket] connect_error', err);
    });

    // Receive assistant reply { response: string } (tolerant to shapes)
    socket.on('bot_response', (payload) => {
      console.debug('[socket] bot_response', payload);
      const response = payload?.response ?? payload?.text ?? payload?.message ?? payload;
      const text =
        typeof response === 'string'
          ? response
          : (response?.content?.[0]?.text?.value || JSON.stringify(response));
      resolveLoader(text);
    });

    // Send user prompt { prompt: string } + show loader
    formEl.addEventListener('submit', (e) => {
      e.preventDefault();
      const text = (inputEl.value || '').trim();
      if (!text) return;
      addMessage('me', text);
      showLoader();
      socket.emit('user_prompt', { prompt: text });
      inputEl.value = '';
      inputEl.focus();
    });
  </script>
</body>

</html>
